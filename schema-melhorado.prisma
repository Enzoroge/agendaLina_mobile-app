// Schema Prisma melhorado para sistema escolar completo
// Copie e substitua seu schema atual por este

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int      @id @default(autoincrement())
  name               String
  email              String   @unique
  password           String
  role               Role
  mustChangePassword Boolean  @default(true)
  ativo              Boolean  @default(true)
  criadoEm           DateTime @default(now())
  atualizadoEm       DateTime @updatedAt

  professor   Professor?
  aluno       Aluno?
  responsavel Responsavel?

  avisosCriados Avisos[] @relation("AvisosCriados")
}

// -------------------- ANO LETIVO --------------------
model AnoLetivo {
  id        Int      @id @default(autoincrement())
  ano       Int      @unique
  inicio    DateTime
  fim       DateTime
  ativo     Boolean  @default(true)
  
  turmas    Turma[]
  bimestres Bimestre[]
}

model Bimestre {
  id          Int       @id @default(autoincrement())
  numero      Int       // 1, 2, 3, 4
  inicio      DateTime
  fim         DateTime
  ativo       Boolean   @default(true)
  
  anoLetivo   AnoLetivo @relation(fields: [anoLetivoId], references: [id], onDelete: Cascade)
  anoLetivoId Int
  
  atividades  Atividade[]
  notas       Nota[]
  medias      MediaBimestre[]

  @@unique([anoLetivoId, numero])
}

// -------------------- TURMA E RELACIONAMENTOS --------------------
model Turma {
  id          Int              @id @default(autoincrement())
  nome        String
  serie       String           // Ex: "6º Ano", "7º Ano", etc.
  turno       Turno            // MANHA, TARDE, NOITE
  capacidade  Int              @default(30)
  ativa       Boolean          @default(true)
  
  anoLetivo   AnoLetivo        @relation(fields: [anoLetivoId], references: [id])
  anoLetivoId Int
  
  professores TurmaProfessor[]
  alunos      TurmaAluno[]     // Relacionamento N:N com histórico
  disciplinas TurmaDisciplina[]

  @@unique([nome, anoLetivoId])
}

model TurmaProfessor {
  id          Int       @id @default(autoincrement())
  turma       Turma     @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  turmaId     Int
  professor   Professor @relation(fields: [professorId], references: [id], onDelete: Cascade)
  professorId Int
  ativo       Boolean   @default(true)
  criadoEm    DateTime  @default(now())

  @@unique([turmaId, professorId])
}

model TurmaAluno {
  id        Int      @id @default(autoincrement())
  turma     Turma    @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  turmaId   Int
  aluno     Aluno    @relation(fields: [alunoId], references: [id], onDelete: Cascade)
  alunoId   Int
  ativo     Boolean  @default(true)
  criadoEm  DateTime @default(now())

  @@unique([turmaId, alunoId])
}

model TurmaDisciplina {
  id           Int        @id @default(autoincrement())
  turma        Turma      @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  turmaId      Int
  disciplina   Disciplina @relation(fields: [disciplinaId], references: [id], onDelete: Cascade)
  disciplinaId Int
  professor    Professor  @relation(fields: [professorId], references: [id], onDelete: Cascade)
  professorId  Int
  cargaHoraria Int        @default(60) // horas por ano
  ativo        Boolean    @default(true)

  @@unique([turmaId, disciplinaId])
}

// -------------------- PROFESSOR --------------------
model Professor {
  id          Int              @id @default(autoincrement())
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int              @unique
  nome        String
  cpf         String?          @unique
  telefone    String?
  
  turmas      TurmaProfessor[]
  disciplinas TurmaDisciplina[]
  atividades  Atividade[]
  notas       Nota[]
}

// -------------------- ALUNO --------------------
model Aluno {
  id             Int        @id @default(autoincrement())
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         Int        @unique
  nome           String
  cpf            String?    @unique
  dataNascimento DateTime?
  telefone       String?
  endereco       String?
  
  turmas         TurmaAluno[]
  notas          Nota[]
  medias         MediaBimestre[]
  situacoes      SituacaoAluno[]
  
  responsaveis   AlunoResponsavel[]
}

// -------------------- RESPONSAVEL --------------------
model Responsavel {
  id       Int     @id @default(autoincrement())
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   Int     @unique
  nome     String
  cpf      String? @unique
  telefone String
  email    String  @unique
  endereco String?
  
  alunos   AlunoResponsavel[]
}

model AlunoResponsavel {
  id            Int         @id @default(autoincrement())
  aluno         Aluno       @relation(fields: [alunoId], references: [id], onDelete: Cascade)
  alunoId       Int
  responsavel   Responsavel @relation(fields: [responsavelId], references: [id], onDelete: Cascade)
  responsavelId Int
  parentesco    Parentesco  // PAI, MAE, TUTOR, etc.
  principal     Boolean     @default(false) // Responsável principal
  
  @@unique([alunoId, responsavelId])
}

// -------------------- DISCIPLINA --------------------
model Disciplina {
  id          Int        @id @default(autoincrement())
  nome        String     @unique
  codigo      String     @unique // Ex: MAT, POR, HIS, etc.
  descricao   String?
  ativa       Boolean    @default(true)
  
  turmas      TurmaDisciplina[]
  atividades  Atividade[]
}

// -------------------- ATIVIDADE --------------------
model Atividade {
  id           Int        @id @default(autoincrement())
  titulo       String
  descricao    String
  tipo         TipoAtividade // PROVA, TRABALHO, EXERCICIO, etc.
  valorMaximo  Float      @default(10.0)
  peso         Float      @default(1.0) // Para cálculo de média ponderada
  dataLimite   DateTime?
  ativa        Boolean    @default(true)
  
  bimestre     Bimestre   @relation(fields: [bimestreId], references: [id], onDelete: Cascade)
  bimestreId   Int
  disciplina   Disciplina @relation(fields: [disciplinaId], references: [id], onDelete: Cascade)
  disciplinaId Int
  professor    Professor  @relation(fields: [professorId], references: [id], onDelete: Cascade)
  professorId  Int
  
  notas        Nota[]
}

// -------------------- NOTA --------------------
model Nota {
  id           Int       @id @default(autoincrement())
  valor        Float
  observacao   String?
  dataLancada  DateTime  @default(now())
  
  aluno        Aluno     @relation(fields: [alunoId], references: [id], onDelete: Cascade)
  alunoId      Int
  atividade    Atividade @relation(fields: [atividadeId], references: [id], onDelete: Cascade)
  atividadeId  Int
  bimestre     Bimestre  @relation(fields: [bimestreId], references: [id], onDelete: Cascade)
  bimestreId   Int
  professor    Professor @relation(fields: [professorId], references: [id], onDelete: Cascade)
  professorId  Int

  @@unique([alunoId, atividadeId]) // Um aluno só pode ter uma nota por atividade
}

// -------------------- MÉDIAS E SITUAÇÃO --------------------
model MediaBimestre {
  id           Int        @id @default(autoincrement())
  valor        Float
  calculadaEm  DateTime   @default(now())
  
  aluno        Aluno      @relation(fields: [alunoId], references: [id], onDelete: Cascade)
  alunoId      Int
  bimestre     Bimestre   @relation(fields: [bimestreId], references: [id], onDelete: Cascade)
  bimestreId   Int
  disciplina   Disciplina @relation(fields: [disciplinaId], references: [id], onDelete: Cascade)
  disciplinaId Int

  @@unique([alunoId, bimestreId, disciplinaId])
}

model SituacaoAluno {
  id                Int         @id @default(autoincrement())
  situacao          Situacao
  mediaFinal        Float?
  pontosNecessarios Float?      // Para recuperação
  observacoes       String?
  calculadoEm       DateTime    @default(now())
  
  aluno             Aluno       @relation(fields: [alunoId], references: [id], onDelete: Cascade)
  alunoId           Int
  disciplina        Disciplina  @relation(fields: [disciplinaId], references: [id], onDelete: Cascade)
  disciplinaId      Int
  anoLetivo         AnoLetivo   @relation(fields: [anoLetivoId], references: [id], onDelete: Cascade)
  anoLetivoId       Int

  @@unique([alunoId, disciplinaId, anoLetivoId])
}

// -------------------- AVISOS --------------------
model Avisos {
  id           Int      @id @default(autoincrement())
  titulo       String
  descricao    String
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  ativo        Boolean  @default(true)

  criadoPor    User     @relation("AvisosCriados", fields: [criadoPorId], references: [id], onDelete: Cascade)
  criadoPorId  Int
}

// -------------------- ENUMS --------------------
enum Role {
  ADMIN
  SECRETARIA
  PROFESSOR
  ALUNO
  RESPONSAVEL
}

enum Situacao {
  APROVADO
  REPROVADO
  RECUPERACAO
  EM_ANDAMENTO
}

enum Turno {
  MANHA
  TARDE
  NOITE
  INTEGRAL
}

enum TipoAtividade {
  PROVA
  TRABALHO
  EXERCICIO
  SEMINARIO
  PROJETO
  PARTICIPACAO
}

enum Parentesco {
  PAI
  MAE
  TUTOR
  AVO
  TIOS
  OUTROS
}